<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DeepSeek Voice Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      font-size: clamp(1rem, 2.8vw, 1.2rem);
      background: #f0f2f5; display: flex; flex-direction: column;
    }
    h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); margin: 0.5em 0; }
    p { margin: 0.5em 0; }
    .welcome {
      text-align: center; padding: 20px;
      max-height: 100%; overflow-y: auto;
    }
    button {
      margin-top: 10px; padding: 12px 20px; border: none;
      border-radius: 20px; background: #4caf50; color: white;
      cursor: pointer; font-size: clamp(1rem, 2.8vw, 1.2rem);
      width: auto;
    }
    #chat-box {
      flex: 1; overflow-y: auto; padding: 10px;
      display: none; flex-direction: column;
    }
    .message {
      display: inline-block; max-width: 70%; min-width: 20%;
      padding: 10px; border-radius: 15px;
      word-wrap: break-word; display: flex; flex-direction: column;
      align-items: flex-start; margin: 5px 0;
    }
    .message audio { margin-top: 5px; width: 100%; }
    .user {
      background: #4caf50; align-self: flex-end;
      text-align: right; margin-left: auto;
      border-radius: 15px 15px 0 15px;
    }
    .bot {
      background: #9fe0f7; align-self: flex-start;
      text-align: left; margin-right: auto;
      border-radius: 15px 15px 15px 0;
    }
    #input-area {
      position: sticky; bottom: 0; background: #fff;
      padding: 10px; gap: 10px; display: none;
      flex-wrap: wrap; justify-content: center;
      z-index: 1000;
    }
    #input {
      flex: 1; padding: 10px; border-radius: 20px;
      border: 1px solid #ccc; outline: none;
      min-width: 0; width: 100%; max-width: 600px;
      font-size: clamp(1rem, 2.8vw, 1.2rem);
    }
    .recording { background: red !important; color: white !important; }
    @media (max-width: 768px) {
      #chat-box { font-size: 18px; }
      #input-area { flex-direction: column; align-items: stretch; }
      #input, #send-btn, #start-btn, #mic-btn { width: 100%; }
      .message { max-width: 70%; }
    }
  </style>
</head>
<body>
  <div class="welcome">
    <h1>Welcome to DeepSeek Voice Chat</h1>
    <p>Record your voice to start</p>
    <button id="record-btn">Record Voice</button>
    <button id="upload-btn">Upload Voice</button>
    <input type="file" id="upload-input" accept=".mp3, .wav, .webm" style="display: none;">
    <audio id="recorded-audio" controls style="display:none;"></audio>
    <button id="proceed-btn">Proceed to Chat</button>
  </div>

  <div id="chat-box"></div>

  <div id="input-area">
    <input id="input" type="text" placeholder="Type your message..." />
    <button id="mic-btn">üé§</button>
    <button id="send-btn">Send</button>
    <button id="start-btn">Start New Chat</button>
  </div>

  <script>
    const backendUrl = "https://logically-sunny-boxer.ngrok-free.app";
    let mediaRecorder, isRecording = false, audioChunks = [];
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send-btn");

    document.getElementById('record-btn').addEventListener('click', () => {
      alert('This button is a placeholder. Please proceed to chat to record with the mic button.');
    });

    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('upload-input').click();
    });

    document.getElementById('upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch(`${backendUrl}/upload-voice/`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        if (data.status === "success") {
          document.getElementById('recorded-audio').src = `${backendUrl}/${data.file}`;
          document.getElementById('recorded-audio').style.display = 'block';
        } else {
          alert("Upload failed: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("An error occurred while uploading.");
      }
    });

    document.getElementById('proceed-btn').addEventListener('click', () => {
      document.querySelector('.welcome').style.display = 'none';
      document.getElementById('chat-box').style.display = 'flex';
      document.getElementById('input-area').style.display = 'flex';
    });

    document.getElementById('mic-btn').addEventListener('click', async () => {
      const micBtn = document.getElementById('mic-btn');

      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const file = new File([blob], 'recorded_audio.webm', { type: 'audio/webm' });
          const formData = new FormData();
          formData.append("file", file);

          const uploadRes = await fetch(`${backendUrl}/upload-voice/`, {
            method: "POST",
            body: formData
          });
          const uploadData = await uploadRes.json();

          console.log("üì° Calling STT endpoint...");
          const sttRes = await fetch(`${backendUrl}/stt/`);
          console.log("‚úÖ STT response received:", sttRes);

          const contentType = sttRes.headers.get("content-type");

          if (!contentType || !contentType.includes("application/json")) {
            const errorHtml = await sttRes.text();
            console.error("Non-JSON response:", errorHtml.slice(0, 300));
            alert("STT failed: non-JSON response");
            return;
          }

          const sttData = await sttRes.json();
          if (sttData.text) {
            input.value = sttData.text;
            sendBtn.click();
          } else {
            alert("No speech detected.");
          }
        };

        mediaRecorder.start();
        micBtn.classList.add('recording');
        micBtn.textContent = "‚èπÔ∏è";
        isRecording = true;
      } else {
        mediaRecorder.stop();
        micBtn.classList.remove('recording');
        micBtn.textContent = "üé§";
        isRecording = false;
      }
    });
  </script>
</body>
</html>
